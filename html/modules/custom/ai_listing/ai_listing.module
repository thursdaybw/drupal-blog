<?php

declare(strict_types=1);

use Drupal\Core\Entity\EntityInterface;
use Drupal\ai_listing\Entity\BbAiListing;
use Drupal\ai_listing\Entity\AiBookBundleItem;
use Drupal\Core\File\FileSystemInterface;
use Drupal\file\FileInterface;

/**
 * Implements hook_entity_predelete().
 */
function ai_listing_entity_predelete(EntityInterface $entity): void {

  $isBookListing = $entity instanceof BbAiListing;
  $isBundleItem = $entity instanceof AiBookBundleItem;

  if (!$isBookListing && !$isBundleItem) {
    return;
  }

  $entityTypeManager = \Drupal::entityTypeManager();
  $fileStorage = $entityTypeManager->getStorage('file');
  $skuStorage = $entityTypeManager->hasDefinition('ai_listing_inventory_sku')
    ? $entityTypeManager->getStorage('ai_listing_inventory_sku')
    : null;
  $publicationStorage = $entityTypeManager->hasDefinition('ai_marketplace_publication')
    ? $entityTypeManager->getStorage('ai_marketplace_publication')
    : null;
  $listingImageStorage = $entityTypeManager->hasDefinition('listing_image')
    ? $entityTypeManager->getStorage('listing_image')
    : null;

  $fileSystem = \Drupal::service('file_system');

  if ($isBookListing) {
    $uuId = $entity->uuid();
    $directory = "public://ai-listings/{$uuId}";

    if ($skuStorage !== null) {
      $skuRecords = $skuStorage->loadByProperties(['listing' => $entity->id()]);
      foreach ($skuRecords as $skuRecord) {
        $skuRecord->delete();
      }
    }

    if ($publicationStorage !== null) {
      $publicationRecords = $publicationStorage->loadByProperties(['listing' => $entity->id()]);
      foreach ($publicationRecords as $publicationRecord) {
        $publicationRecord->delete();
      }
    }

    if ($listingImageStorage !== null) {
      $ids = $listingImageStorage->getQuery()
        ->accessCheck(FALSE)
        ->condition('owner.target_type', 'bb_ai_listing')
        ->condition('owner.target_id', (int) $entity->id())
        ->execute();
      $listingImages = $ids === [] ? [] : $listingImageStorage->loadMultiple($ids);
      foreach ($listingImages as $listingImage) {
        $fileId = (int) ($listingImage->get('file')->target_id ?? 0);
        if ($fileId > 0) {
          $file = $fileStorage->load($fileId);
          if ($file) {
            $file->delete();
          }
        }
        $listingImage->delete();
      }
    }

    $bundleItems = $entityTypeManager->getStorage('ai_book_bundle_item')
      ->loadByProperties(['bundle_listing' => $entity->id()]);
    foreach ($bundleItems as $bundleItem) {
      $bundleItem->delete();
    }

    if ($fileSystem->prepareDirectory($directory, FileSystemInterface::MODIFY_PERMISSIONS)) {
      $realPath = $fileSystem->realpath($directory);
      if ($realPath && is_dir($realPath)) {
        $fileSystem->deleteRecursive($directory);
      }
    }
  }

  if ($isBundleItem && $listingImageStorage !== null) {
    $ids = $listingImageStorage->getQuery()
      ->accessCheck(FALSE)
      ->condition('owner.target_type', 'ai_book_bundle_item')
      ->condition('owner.target_id', (int) $entity->id())
      ->execute();
    $listingImages = $ids === [] ? [] : $listingImageStorage->loadMultiple($ids);
    foreach ($listingImages as $listingImage) {
      $listingImage->delete();
    }
  }
}


/**
 * Implements hook_entity_insert().
 */
function ai_listing_entity_insert(\Drupal\Core\Entity\EntityInterface $entity): void {

  if (!$entity instanceof FileInterface) {
    return;
  }

  if (strpos($entity->getMimeType(), 'image/') !== 0) {
    return;
  }

  \Drupal::service('ai_listing.image_normalization')
    ->normalize($entity->getFileUri());
}

/**
 * Implements hook_theme().
 */
function ai_listing_theme($existing, $type, $theme, $path) {
  return [
    'ai_tile_radios' => [
      'render element' => 'element',
      'template' => 'ai-tile-radios',
    ],
    'ai_tile_checkboxes' => [
      'render element' => 'element',
      'template' => 'ai-tile-checkboxes',
    ],
    'ai_listing_format_field' => [
      'render element' => 'element',
      'template' => 'ai-format-field',
      'base hook' => 'input',
    ],
  ];
}
