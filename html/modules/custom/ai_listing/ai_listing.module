<?php

declare(strict_types=1);

use Drupal\Core\Entity\EntityInterface;
use Drupal\ai_listing\Entity\AiBookListing;
use Drupal\Core\File\FileSystemInterface;
use Drupal\file\FileInterface;

/**
 * Implements hook_entity_predelete().
 */
function ai_listing_entity_predelete(EntityInterface $entity): void {

  if (!$entity instanceof AiBookListing) {
    return;
  }

  $entityTypeManager = \Drupal::entityTypeManager();
  $fileStorage = $entityTypeManager->getStorage('file');
  $skuStorage = $entityTypeManager->hasDefinition('ai_listing_inventory_sku')
    ? $entityTypeManager->getStorage('ai_listing_inventory_sku')
    : null;
  $publicationStorage = $entityTypeManager->hasDefinition('ai_marketplace_publication')
    ? $entityTypeManager->getStorage('ai_marketplace_publication')
    : null;

  $fileSystem = \Drupal::service('file_system');

  $uuId = $entity->uuid();
  $directory = "public://ai-listings/{$uuId}";

  foreach ($entity->get('images') as $item) {

    $file = $fileStorage->load($item->target_id);

    if ($file) {
      $file->delete();
    }
  }

  if ($skuStorage !== null) {
    $skuRecords = $skuStorage->loadByProperties(['ai_book_listing' => $entity->id()]);
    foreach ($skuRecords as $skuRecord) {
      $skuRecord->delete();
    }
  }

  if ($publicationStorage !== null) {
    $publicationRecords = $publicationStorage->loadByProperties(['ai_book_listing' => $entity->id()]);
    foreach ($publicationRecords as $publicationRecord) {
      $publicationRecord->delete();
    }
  }

  if ($fileSystem->prepareDirectory($directory, FileSystemInterface::MODIFY_PERMISSIONS)) {
    $realPath = $fileSystem->realpath($directory);
    if ($realPath && is_dir($realPath)) {
      $fileSystem->deleteRecursive($directory);
    }
  }
}


/**
 * Implements hook_entity_insert().
 */
function ai_listing_entity_insert(\Drupal\Core\Entity\EntityInterface $entity): void {

  if (!$entity instanceof FileInterface) {
    return;
  }

  if (strpos($entity->getMimeType(), 'image/') !== 0) {
    return;
  }

  \Drupal::service('ai_listing.image_normalization')
    ->normalize($entity->getFileUri());
}

/**
 * Implements hook_theme().
 */
function ai_listing_theme($existing, $type, $theme, $path) {
  return [
    'ai_tile_radios' => [
      'render element' => 'element',
      'template' => 'ai-tile-radios',
    ],
    'ai_tile_checkboxes' => [
      'render element' => 'element',
      'template' => 'ai-tile-checkboxes',
    ],
    'ai_listing_format_field' => [
      'render element' => 'element',
      'template' => 'ai-format-field',
      'base hook' => 'input',
    ],
  ];
}
